<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apps & Resume</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#0f1620; --muted:#161e29; --text:#e6eef8; --sub:#9fb0c6;
      --brand:#58a6ff; --accent:#7cfeea; --ring:#2a3a52;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a0e13,#0b1220 50%,#0a0e13);font:500 15px/1.5 system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
    .wrap{max-width:980px;margin:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font:700 26px/1.2 ui-sans-serif;color:#fff;margin:0}
    .sub{color:var(--sub);font-size:14px}
    nav{display:flex;gap:8px}
    .tab{background:transparent;border:1px solid var(--ring);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#001222}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:1fr 1fr}
    @media (max-width:840px){.grid.two{grid-template-columns:1fr}}
    input,textarea,select{width:100%;background:#0e141c;border:1px solid #213148;color:var(--text);border-radius:10px;padding:10px;outline:none}
    textarea{min-height:160px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#001222;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#172233;color:var(--text);border:1px solid var(--ring)}
    .row{display:flex;gap:8px;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1e2a3c}
    th{color:var(--sub);font-weight:600;text-align:left}
    .muted{color:var(--sub)}
    .pill{padding:4px 8px;border-radius:999px;background:#172233;border:1px solid var(--ring);font-size:12px}
    .notice{position:fixed;inset:auto 16px 16px auto;background:#0f1a29;border:1px solid var(--ring);padding:10px 14px;border-radius:12px;display:none}
    .show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Apps & Resume</h1>
        <div class="sub">Track applications and tailor your resume with AI</div>
      </div>
      <nav>
        <button class="tab active" data-tab="dash">Dashboard</button>
        <button class="tab" data-tab="tailor">Resume Tailor</button>
      </nav>
    </header>

    <!-- Dashboard -->
    <section id="dash" class="grid">
      <div class="card grid">
        <div class="grid two">
          <div>
            <label class="muted">Job URL</label>
            <input id="jobUrl" type="url" placeholder="Paste a job posting URL" />
          </div>
          <div class="row" style="margin-top:auto">
            <button id="addBtn" class="btn">Extract & Add</button>
            <button id="clearBtn" class="btn secondary" title="Clear all saved applications">Clear All</button>
          </div>
        </div>
        <div class="grid two">
          <div>
            <label class="muted">Filter by company</label>
            <input id="companyFilter" placeholder="e.g. Stripe" />
          </div>
          <div>
            <label class="muted">Sort</label>
            <select id="sortSelect">
              <option value="date:desc">Newest</option>
              <option value="date:asc">Oldest</option>
              <option value="company:asc">Company Aâ†’Z</option>
              <option value="company:desc">Company Zâ†’A</option>
              <option value="title:asc">Title Aâ†’Z</option>
              <option value="title:desc">Title Zâ†’A</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Title</th><th>Company</th><th>Job ID</th><th>Status</th><th>Referral</th><th>Link</th><th></th>
            </tr>
          </thead>
          <tbody id="appsBody"></tbody>
        </table>
        <div id="empty" class="muted" style="padding:12px;display:none">No applications yet.</div>
      </div>
    </section>

    <!-- Tailor -->
    <section id="tailor" class="grid" style="display:none">
      <div class="card grid">
        <div class="row" style="gap:6px">
          <button class="btn secondary" data-mode="url">Use Job URL</button>
          <button class="btn secondary" data-mode="text">Use Job Description</button>
          <span class="pill" id="modePill">mode: url</span>
        </div>
        <div id="urlBox">
          <label class="muted">Job URL</label>
          <input id="resumeJobUrl" type="url" placeholder="Paste a job URL to tailor your resume" />
        </div>
        <div id="textBox" style="display:none">
          <label class="muted">Job description</label>
          <textarea id="jobDescription" placeholder="Paste the job description"></textarea>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="tailorBtn" class="btn">ðŸ¤– Tailor Resume</button>
          <button id="downloadBtn" class="btn secondary">Download PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="muted" style="margin-bottom:8px">Tailored Resume Preview</div>
        <pre id="resumeContent" style="white-space:pre-wrap;margin:0"></pre>
      </div>
    </section>

    <div class="notice" id="notice"></div>
  </div>

  <script>
    // ==== Config ==== //
    const FN_BASE = '/.netlify/functions';
    const STORE_KEY = 'applications_v1';

    // ==== State ==== //
    let apps = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
    let mode = 'url';

    // ==== Helpers ==== //
    const $ = (id)=>document.getElementById(id);
    const notice = (msg)=>{ const n=$('notice'); n.textContent=msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'),2500); };
    const save = ()=>localStorage.setItem(STORE_KEY, JSON.stringify(apps));

    const fmtDate = (d)=> new Date(d).toISOString().slice(0,10);

    function render(){
      const filter = $('companyFilter').value.trim().toLowerCase();
      const [field,dir] = $('sortSelect').value.split(':');
      const sorted = [...apps].sort((a,b)=>{
        const A = (field==='date')? a.date : (a[field]||'').toLowerCase();
        const B = (field==='date')? b.date : (b[field]||'').toLowerCase();
        return (A>B?1:A<B?-1:0) * (dir==='asc'?1:-1);
      }).filter(a=>!filter || (a.company||'').toLowerCase().includes(filter));

      const body = $('appsBody'); body.innerHTML='';
      if(!sorted.length){ $('empty').style.display='block'; return } else { $('empty').style.display='none'; }

      for(const a of sorted){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.date}</td>
          <td>${a.title||'-'}</td>
          <td>${a.company||'-'}</td>
          <td>${a.jobId||'-'}</td>
          <td>
            <select data-id="${a.id}" class="statusSel">
              ${['Applied','Interviewing','Offer','Rejected'].map(s=>`<option ${a.status===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td><input type="checkbox" data-id="${a.id}" class="refChk" ${a.referral?'checked':''}></td>
          <td>${a.url?`<a class="pill" href="${a.url}" target="_blank">open</a>`:''}</td>
          <td><button class="btn secondary delBtn" data-id="${a.id}">Delete</button></td>`;
        body.appendChild(tr);
      }
      // attach listeners
      body.querySelectorAll('.statusSel').forEach(el=>el.onchange=(e)=>{
        const id = +e.target.dataset.id; const it = apps.find(x=>x.id===id); it.status = e.target.value; save(); notice('Status updated');
      });
      body.querySelectorAll('.refChk').forEach(el=>el.onchange=(e)=>{
        const id = +e.target.dataset.id; const it = apps.find(x=>x.id===id); it.referral = e.target.checked; save(); notice('Referral updated');
      });
      body.querySelectorAll('.delBtn').forEach(el=>el.onclick=(e)=>{
        const id = +e.target.dataset.id; apps = apps.filter(x=>x.id!==id); save(); render(); notice('Deleted');
      });
    }

    // ==== Tabs ==== //
    document.querySelectorAll('.tab').forEach(b=>b.onclick=(e)=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      e.target.classList.add('active');
      const tab=e.target.dataset.tab; document.querySelector('#dash').style.display=tab==='dash'?'grid':'none'; document.querySelector('#tailor').style.display=tab==='tailor'?'grid':'none';
      if(tab==='dash') render();
    });

    // ==== Dashboard actions ==== //
    $('addBtn').onclick = async ()=>{
      const url = $('jobUrl').value.trim(); if(!url) return notice('Please paste a job URL');
      $('addBtn').disabled = true; $('addBtn').textContent = 'Extractingâ€¦';
      try{
        const r = await fetch(`${FN_BASE}/scrape`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url})});
        if(!r.ok) throw new Error('scrape failed');
        const {data} = await r.json();
        const item = { id: Date.now(), date: fmtDate(new Date()), status:'Applied', referral:false, ...data };
        apps.push(item); save(); render(); $('jobUrl').value=''; notice('Added');
      }catch(err){ console.error(err); notice('Could not extract job data'); }
      $('addBtn').disabled=false; $('addBtn').textContent='Extract & Add';
    };
    $('clearBtn').onclick = ()=>{ if(confirm('Delete ALL saved applications?')){ apps=[]; save(); render(); } };
    $('companyFilter').oninput = render; $('sortSelect').onchange = render;

    // ==== Tailor actions ==== //
    document.querySelectorAll('[data-mode]').forEach(b=>b.onclick=(e)=>{
      mode = e.target.dataset.mode; $('modePill').textContent = `mode: ${mode}`;
      $('urlBox').style.display = mode==='url'?'block':'none';
      $('textBox').style.display = mode==='text'?'block':'none';
    });

    $('tailorBtn').onclick = async ()=>{
      let jobInput = mode==='url' ? $('resumeJobUrl').value.trim() : $('jobDescription').value.trim();
      if(!jobInput) return notice('Provide a URL or description');
      $('tailorBtn').disabled = true; $('tailorBtn').textContent = 'Tailoringâ€¦';
      try{
        const r = await fetch(`${FN_BASE}/tailor-resume`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jobInput, inputType: mode })});
        const data = await r.json(); if(!r.ok || !data.success) throw new Error(data.error||'AI failed');
        $('resumeContent').textContent = data.tailoredResume; notice('Tailored!');
      }catch(err){ console.error(err); notice('Failed to tailor resume'); }
      $('tailorBtn').disabled=false; $('tailorBtn').textContent='ðŸ¤– Tailor Resume';
    };

    $('downloadBtn').onclick = async ()=>{
      const text = $('resumeContent').textContent.trim(); if(!text) return notice('Nothing to download');
      $('downloadBtn').disabled = true; $('downloadBtn').textContent = 'Generatingâ€¦';
      try{
        const r = await fetch(`${FN_BASE}/download-resume`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text })});
        if(!r.ok) throw new Error('pdf failed');
        const blob = await r.blob();
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tailored-resume.pdf'; a.click(); URL.revokeObjectURL(url);
        notice('Downloaded PDF');
      }catch(err){ console.error(err); notice('Failed to download'); }
      $('downloadBtn').disabled=false; $('downloadBtn').textContent='Download PDF';
    };

    // init
    render();
  </script>
</body>
</html>